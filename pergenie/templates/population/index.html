{% extends "layout.html" %}
{% block title %}Population{% endblock %}
{% block description %}population{% endblock %}
{% load staticfiles %}
{% load extras %}

{% block main_container %}
<div id="main_container" class="span14">
  <section id="main">

    <div class="container">

      <div class="row-fluid">
        <div class="span12">
          <div class="content-box transparent">
            <div class="padded">
              <h2>Population</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- alerts -->
      {% if msg %}
      <div class="alert alert-info">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <strong>Information:</strong> {{ msg }}
      </div>
      {% endif %}

      {% if err %}
      <div class="alert alert-error">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <strong>Error!</strong> {{ err }}
      </div>
      {% endif %}

      <div class="row-fluid">
        <div class="span14">
          <div class="content-box">
            <div class="content-box-header">
              <icon class="icon-globe"></icon>
            </div>

            <div class="padded">
              <div class="row-fluid">
                <div class="span14">
                  <p>PCAベースのAncestral Analysisをして，</p>
                  <ul>
                    <li>地図</li>
                    <li>PCAの主成分空間の二次元・三次元上の民族クラスタにプロットした図</li>
                  </ul>
                  <p>などを載せる予定です．</p>


                  <hr>
                  <p>Scale: {{ scale }}</p>

                  <hr>
                  <p>People:</p>
                  {% for one in people %}
                  <p>{{ one }}</p>
                  {% endfor %}

                  <hr>
                  <p>Person:</p>
                  <p>{{ person }}</p>

                  <div id="pca-chart" style="width: 500px; height: 500px;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript" src="{% static 'js/highcharts/highcharts.js' %}"></script>
<script type="text/javascript" src="{% static 'js/highcharts/highcharts-more.js' %}"></script>
<script type="text/javascript">
(function () {
  {% regroup people by 1 as people_groups %}

  var pcaData = [
    {% for people_group in people_groups %}
    {
      name: "{{ people_group.grouper }}",
      data: [
          {% for pos, label in people_group.list %}[{{ pos.0 }}, {{ pos.1 }}, 1],
          {% endfor %}
      ],
      parent: null,
      events: {
        click: function (e) {
          var childData = findPcaDataByParent("{{ people_group.grouper }}");
          if (childData.length > 0) {
            savePcaData();
            removePcaData();
          }
        }
      }
    },
    {% endfor %}
    {
      name: "Person",
      data: [
          [{{ person.0 }}, {{ person.1 }}, 1]
      ],
    }
  ]; // var pcaData

  var pcaChart = null;
  var undoStack = [];

  var findPcaDataByParent = function (name) {
    var data = [];
    $.each(pcaData, function () {
      if (this.parent == name) data.push(this);
    });

    return data;
  }; // var findPcaDataByParent

  var removePcaData = function () {
    var n = pcaChart.series.length;
    for (var i = 0; i < n; i++) pcaChart.series[0].remove();
  }; // var removePcaData

  var savePcaData = function () {
    var currentData = [];
    $.each(pcaChart.series, function () {
      currentData.push(this.name);
    });

    undoStack.push(currentData);
  }; // var savePcaData

  var restorePcaData = function () {
    if (undoStack.length == 0) return;

    removePcaData();

    $.each(undoStack.pop(), function () {
      var pcaDataName = this;
      $.each(pcaData, function () {
        if (this.name == pcaDataName) pcaChart.addSeries(this);
      });
    });
  }; // var restorePcaData

  var pcaChartOpts = {
    chart: {
      renderTo: "pca-chart",
      type: "bubble",
      plotBorderWidth: 1,
      zoomType: "xy",
      events: {
        click: function (e) {
          restorePcaData();
        }
      }
    },
    title: {
      text: "TODO"
    },
    subtitle: {
      text: "TODO"
    },
    xAxis: {
      gridLineWidth: 1,
      title: { text: "PC1" }
    },
    yAxis: {
      gridLineWidth: 2,
      title: { text: "PC2" }
    },
    plotOptions: {
      bubble: {
        minSize: "10px",
        maxSize: "10px",
      }
    },
    tooltip: {
      formatter: function () {
        return "<b>" + this.series.name + "</b><br>" + this.x + ", " + this.y;
      }
    },
  }; // var chartOpts

  $(document).ready(function () {
    pcaChart = new Highcharts.Chart(pcaChartOpts);

    $.each(findPcaDataByParent(null), function () {
      pcaChart.addSeries(this);
    });
  });
})();
</script>
{% endblock %}
