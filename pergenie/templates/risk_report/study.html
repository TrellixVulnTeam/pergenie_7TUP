{% extends "layout.html" %}
{% block title %}Risk report - {{ study_name }}{% endblock %}
{% block description %}risk report detail{% endblock %}
<!-- {% block cookie_id %}risk_report_detail{% endblock %} -->
{% load staticfiles %}
{% load extras %}

{% block main_container %}
<div id="main_container" class="span12">
  <section id="main">

    <div class="container">

      <!-- Breadcrumb -->
      <div class="row-fluid">
        <div class="span12">
          <ul class="breadcrumb">
            <li><a href="{% url apps.riskreport.views.index %}">Risk report</a><span class="divider">/</span></li>
            <li class="active">{{ trait }}<span class="divider">/</span></li>
            <li class="active">{{ study }}</li>
          </ul>

          <div class="content-box transparent">
            <div class="padded10">
              <h4>{{ trait }}{% if is_ja %} ({{ trait_eng }}){% endif %}
                {% if wiki_url_en %}<span class="badge badge-yellow"><a href="{{ wiki_url_en }}" target="_blank">Wikipedia</a></span>{% endif %}
              </h4>
            </div>
          </div>
        </div>
      </div>

      <div class="row-fluid">
        <div class="span2">
          <div class="content-box">

            <div class="content-box-header">
              <i class="icon-bar-chart"></i> Effects of SNPs
            </div>

            <!-- <div id="container" style="max-width: 100px; height: 300px; margin: auto"></div> -->
            <div id="container"> <!-- style="max-width: 400px; height: 300px; margin: 0 auto"></div> -->
            </div>
          </div>
        </div>

        <div class="span10">
          <div class="content-box">
            <div class="content-box-header">
              <i class="icon-book"></i> Information about reference study
            </div>

            <table class="table table-hover">
              <tbody>
                <tr>
                  <td>Study name</td>
                  <td>{{ study }} <span class="badge badge-yellow"><a href="{{ record.catalog_info.pubmed_link }}" target="_blank">Pubmed</a></span></td>
                </tr>
                <tr>
                  <td>Population</td>
                  <td>
                    {% if record.catalog_info.population %}
                    {% for p in record.catalog_info.population %}
                    <span class="badge badge-green">{{ p }}</span>
                    {% endfor %}
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td>Initial sample size</td>
                  <td>{{ record.catalog_info.initial_sample_size }}</td>
                </tr>
                <tr>
                  <td>Journal</td>
                  <td>{{ record.catalog_info.jornal }}</td>
                </tr>
                <tr>
                  <td>First author</td>
                  <td>{{ record.catalog_info.first_author }}</td>
                </tr>
                <tr>
                  <td>Date</td>
                  <td>{{ record.catalog_info.date|date }}</td>
                </tr>
                <tr>
                  <td>p-value</td>
                  <td>{{ record.catalog_info.p_value }}</td>
                </tr>
                <tr>
                  <td><a href="#">Reliability rank <i class="icon-question-sign"></i></a></td>
                  <td>
                    {% for r in record.rank %}
                    {% ifequal r "m" %}<span class="label label-green">Meta</span>
                    {% else %}{% ifequal r "*" %}<i class="icon-star"></i>{% endifequal %}{% endifequal %}
                    {% endfor %}

                  </td>
                <!-- <tr> -->
                <!--   <td>RR</td> -->
                <!--   <td>{{ record.RR }}</td> -->
                <!-- </tr> -->
                </tr>
              </tbody>
            </table>

            <!-- TODO: support Other studies -->
            <!-- <a href="{% url apps.riskreport.views.trait trait=trait_name %}">
<button class="btn btn-green"><i class="icon-book icon-white" style="margin-top: 1px;"></i> Other studies</button></a> -->
          </div>
        </div>
      </div>

      <div class="row-fluid">
        <div class="span12">
          <div class="content-box">

            <div class="content-box-header">
              <i class="icon-bar-chart"></i> Information about SNPs & Genotypes of "{{ file_name }}"
            </div>


              <table cellpadding="0" cellspacing="0" border="0" class="display datatable" id="risk_reports_table">
                <thead>
                  <tr>
                    <th>SNPs</th>
                    <th>Chrom.</th>
                    <th>Pos.</th>
                    {% ifequal info.file_format 'vcf_exome_truseq' %}
                    <th>in TrueSeq</th>
                    {% endifequal %}
                    <th>Context</th>
                    <th>Gene</th>
                    <th>Genotype</th>
                    <th>Reference allele</th>
                    <th>Risk allele</th>
                    <th>Risk allele frequency</th>
                    <th>OR in GWAS</th>
                    <th>Risk of yours</th>
                  </tr>
                </thead>

                <tbody>
                  {% for snp_record in snp_records %}
                  <tr>
                    <td class="center"><span class="dbsnp" title="browse in dbSNP"><a href="http://www.ncbi.nlm.nih.gov/projects/SNP/snp_ref.cgi?rs={{ snp_record.snp }}" target="_blank">rs{{ snp_record.snp }}</a></span></td>
                    <td class="center">{{ snp_record.catalog_info.chr_id }}</td>
                    <td class="center">{{ snp_record.catalog_info.chr_pos }}</td>
                    {% ifequal info.file_format 'vcf_exome_truseq' %}
                    <td class="center">{{ snp_record.catalog_info.is_in_truseq }}</td>
                    {% endifequal %}
                    <td class="center">{{ snp_record.catalog_info.context }}</td>
                    <td class="center">
                      {% for gene in snp_record.catalog_info.mapped_genes %}
                      {% if forloop.counter0|add:1 > 1 %}-{% endif %}

                      {% if gene.entrez_gene_id %}<span class="entrez" title="browse in NCBI Gene"><a href="http://www.ncbi.nlm.nih.gov/gene/?term={{ gene.entrez_gene_id }}" target="_blank">{% endif %}
                        {{ gene.gene_symbol }}
                      {% if gene.entrez_gene_id %}</a></span>{% endif %}
                      <!-- {% if gene.omim_gene_id %}<span class="badge badge-yellow"><a href="{{ gene.omim_gene_id }}" target="_blank">OMIM</a></span>{% endif %} -->
                      <!-- {% if gene.entrez_gene_id %}<span class="badge badge-yellow"><a href="{{ gene.entrez_gene_id }}" target="_blank">E</a></span>{% endif %} -->
                      {% endfor %}
                    </td>
                    <td class="center">
                      <span{% if not snp_record.genotype.0 in snp_record.catalog_info.risk_allele %} style="color : #c5c5c5"{% endif %}>{{ snp_record.genotype.0 }}</span>
                      <span{% if not snp_record.genotype.1 in snp_record.catalog_info.risk_allele %} style="color : #c5c5c5"{% endif %}>{{ snp_record.genotype.1 }}</span>
                    </td>
                    <td class="center">{{ snp_record.catalog_info.ref }}</td>
                    <td class="center">{{ snp_record.catalog_info.risk_allele }}</td>
                    <td class="center">{{ snp_record.catalog_info.risk_allele_frequency }}</td>
                    <td class="center">{{ snp_record.catalog_info.OR }}</td>
                    <td class="center">{{ snp_record.RR }}</td>
		          </tr>
                  {% endfor %}
                </tbody>
              </table>

            </div>
          </div>
        </div>
      </div>
  </section>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
$(function () {
    var chart;
    $(document).ready(function() {
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container',
                type: 'column'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: [{% for snp_record in snp_records %}"rs{{ snp_record.snp }}",{% endfor %}],
                labels: {
                    rotation: -45,
                    align: 'right',
                }
            },
            yAxis: {
                max: 10.0,
                min: -10.0,
                title: {
                    text: 'Risk relative to average population'
                }
            },

            tooltip: {
                formatter: function() {
                    return '<b>'+ this.x +'</b><br/>' +
                           ': x' + ((this.y == 0.0) ? 1.0 : this.y);
                }
            },
            credits: {
                enabled: false
            },
            exporting: {
                enabled: false
            },
            legend: {
                enabled: false
            },
            series: [{
                name: "{{ file_name }}",
                data: [{% for snp_record in snp_records %}
                         {y: {% ifnotequal snp_record.RR|abs 1.0 %}{{ snp_record.RR }}{% else %}0.0{% endifnotequal %},
                          color: {% if snp_record.RR < 0 %}'#2ca6f1'{% elif snp_record.RR == 0 %}'#8a8a8a'{% else %}'#f12ca6'{% endif %},
                          },
                       {% endfor %}],
                },
            ]


        });
    });

});
</script>

<script type="text/javascript" src="{% static 'js/highcharts/highcharts.js' %}"></script>
<script type="text/javascript" src="{% static 'js/highcharts/modules/exporting.js' %}"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('#risk_reports_table').dataTable({
    "bJQueryUI": true,
    "sPaginationType": "full_numbers",
    "iDisplayLength": 30,
    "oLanguage": {
            "sZeroRecords": "Nothing found - sorry",
            "sInfo": "Showing _START_ to _END_ of _TOTAL_ records",
            "sInfoEmpty": "Showing 0 to 0 of 0 records",
            "sInfoFiltered": "(filtered from _MAX_ total records)"
    },
    "sDom": '<"top">t<"bottom"p><"clear">'
  });
});
</script>
<script type="text/javascript">$('span.dbsnp').tooltip();</script>
<script type="text/javascript">$('span.entrez').tooltip();</script>
{% endblock %}
