{% extends "layout.html" %}
{% block title %}Risk report{% endblock %}
{% block description %}risk report{% endblock %}
{% load staticfiles %}
{% load extras %}
{% load i18n %}

{% block main_container %}
<div class="row">
  <div class="col-md-12">
    <div class="content-box carving no-box-shadow" data-step="1" data-intro="{% trans "Your disease risk report is shown bellow." %}">
      <h2>{% trans "Disease Risk Report" %}</h2>
      <a href="{% url apps.faq.views.index%}#how_risk_calclulated">[FAQ] {% trans "How are the disease risk values calculated?" %}</a>
    </div>
  </div>
</div>

{% if not err %}
<div class="row">
  <div class="col-md-12">

    <div class="content-box" data-step="2" data-intro="{% trans "Information about this genome file is here." %}">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th><span class="glyphicon glyphicon-user"></span>{% trans "Genome file" %}</th>
            <th><span class="glyphicon glyphicon-globe"></span>{% trans "Population" %}</th>
            <th><span class="glyphicon glyphicon-file"></span>{% trans "File Format" %}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- Genome file -->
            <td class="center" data-step="3" data-intro="{% trans "You can select and change genome files here." %}">
              <form action="{% url apps.riskreport.views.index %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
		        <fieldset>
                  <select name="file_name" onchange="submit(this.form)" class="form-control input-sm">
                    {% for info in infos %}
                    <option value="{{ info.name }}" {% if info.name == tmp_info.name %}selected{% endif %}>{{ info.raw_name }}</option>
                    {% endfor %}
                    <option value="{{ info.name }}"> --</option>
                    <option value="{{ info.name }}"> View All Files</option>
                  </select>
                </fieldset>
              </form>
            </td>

            <!-- Population -->
            <td class="center" data-step="4" data-intro="{% trans "Also, you can change population setting for this genome file." %}">
              <a data-toggle="modal" href="#changeModal"><span class="label label-info">{{ tmp_info.population }}</span></a>

              <!-- changeModal -->
              <div class="modal fade" id="changeModal{{ forloop.counter0 }}" tabindex="-1" role="dialog" aria-labelledby="changeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <!-- <div class="modal-header"> -->
                    <!--   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button> -->
                    <!--   <h4 class="modal-title" id="changeModalLabel"></h4> -->
                    <!-- </div> -->

                    <div class="modal-body">
                      {% trans "Change population to ..." %}
                      <form action="{% url apps.riskreport.views.index %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
		                <fieldset>
                          <select name="population" onchange="submit(this.form)" class="population" title="{% trans "change population?" %}">
                            <option value="unknown" {% ifequal tmp_info.population 'unknown' %}selected{% endifequal %}>Unknown</option>
                            <option value="Asian" {% ifequal tmp_info.population 'Asian' %}selected{% endifequal %}>Asian</option>
                            <option value="European" {% ifequal tmp_info.population 'European' %}selected{% endifequal %}>European</option>
                            <option value="Japanese" {% ifequal tmp_info.population 'Japanese' %}selected{% endifequal %}>Japanese</option>
                          </select>
                        </fieldset>
                        <input type="hidden" name="file_name" value="{{ file_name }}" />
                      </form>
                    </div>

                    <!-- <div class="modal-footer"> -->
                    <!-- </div> -->
                  </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->

            </td>

            <!-- File Format -->
            <td class="center">
              {{ tmp_info.file_format|file_format }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="content-box"  data-step="5" data-intro="{% trans "Your top 10 highest risks are listed here." %}">
      <div class="content-box-header">
        <span class="glyphicon glyphicon-align-left"></span> {% trans "Top 10 Highest Risks" %}
      </div>

      <div class="row">
        <div class="col-md-12">
          {% if h_risk_traits %}
          <div id="container_highest_risks"></div>
          <a href="{% url apps.riskreport.views.show_all %}"><button class="btn btn-info" data-step="6" data-intro="{% trans "To see all the disease risks and/or compare two genomes, click here!" %}"><span class="glyphicon glyphicon-zoom-in"></span> {% trans "Show more" %}</button></a>

          <a href="{% url apps.riskreport.views.export %}?file_name={{ tmp_info.name }}"><button class="btn btn-info"><span class="glyphicon glyphicon-cloud-download"></span> {% trans "Download" %}</button></a>

          {% else %}
          <p>{% trans "Sorry, you have no data for disease risk." %}</p>
          <p>{% trans "Probably, uploaded data was too few to calculate risk." %}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>


  <div class="col-md-6">
    <div class="content-box">
      <div class="content-box-header">
        <span class="glyphicon glyphicon-ok-sign"></span> {% trans "Statistics" %}
      </div>

      <table class="table table-bordered">
        <tbody>

          <tr>
            <td>
              {% trans "Number of studies for this population is " %}
              <b>{{ tmp_info.n_studies }}</b>.<br>
            </td>
          </tr>

          <tr>
            <td class="center">
              <p>{% trans "What percentage does your genome file cover SNPs of these studies?" %}</p>
            </td>
            <td class="center">
              <div class="donut donut-big">
                <div class="donut-arrow" data-percentage="{{ tmp_info.catalog_cover_rate }}"></div>
              </div>
            </td>
          </tr>

          <!-- <tr> -->
          <!--   <td class="center"> -->
          <!--     <p>{% trans "What percentage does your genome file cover whole genome?" %}</p> -->
          <!--   </td> -->
          <!--   <td class="center"> -->
          <!--     <div class="donut donut-big"> -->
          <!--       <div class="donut-arrow" data-percentage="{{ tmp_info.genome_cover_rate }}"></div> -->
          <!--     </div> -->
          <!--   </td> -->
          <!-- </tr> -->
        </tbody>
      </table>

    </div>
  </div>
</div>
{% endif %}


{% endblock %}

{% block js %}

<script type="text/javascript" src="{% static 'js/highcharts/highcharts.js' %}"></script>
<script type="text/javascript" src="{% static 'js/highcharts/modules/exporting.js' %}"></script>


<script type="text/javascript">
$(function () {
    var chart;
    $(document).ready(function() {
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container_highest_risks',
                type: 'bar'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: [{% for trait in h_risk_traits %}
                             "{% autoescape off %}{{ trait|limit:20 }}{% endautoescape %}",
                             {% endfor %}],
                title: {
                    text: null
                }
            },
            yAxis: {
                max: 10,
                min: 1,
                title: {
                    text: '[{% trans "Risk relative to average population" %}]',
                    align: 'high'
                }
            },
            tooltip: {
                formatter: function() {
                    return ''+
                           this.x + ': x' + ((this.y == 0.0) ? 1.0 : this.y);
                }
            },
            plotOptions: {
            series: {
                shadow:false,
                cursor:'pointer',
                    point: {
                        events: {
                            click: function() {
                                location.href = this.options.url;
                                <!-- window.open(this.options.url); -->
                            }
                        }
                    }
                },
                bar: {
                    dataLabels: {
                        enabled: true,
                        rotation: 0,
                        color: '#FFFFFF',
                        align: 'right',
                        x: 0,
                        y: 0,
                        style: {
                            fontSize: '13px',
                            fontFamily: 'Verdana, sans-serif'
                        }
                    }
                }
            },
            credits: {
                enabled: false
            },
            exporting: {
                enabled: false
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -50,
                y: 50,
                floating: true,
                borderWidth: 1,
                backgroundColor: '#FFFFFF',
                shadow: true,
                enabled: false
            },

            series: [
                    {
                    name: '{{ tmp_info.name }}',
                    data: [{% for risk_value in h_risk_values %}
                             {y: {% ifnotequal risk_value 1.0 %}{{ risk_value }}{% else %}0.0{% endifnotequal %},
                              color: {% if risk_value < 0 %}'#2ca6f1'{% elif risk_value == 0 %}'#8a8a8a'{% else %}'#f12ca6'{% endif %},
                              url:"{% url apps.riskreport.views.study trait=h_risk_traits|listvalue:forloop.counter0|urlencode study=h_risk_studies|listvalue:forloop.counter0|urlencode %}?file_name={{ tmp_info.name}}"},
                           {% endfor %}],
                    },
            ]
        });
    });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  $('#risk_reports_table').dataTable({
    "bJQueryUI": true,
    "sPaginationType": "full_numbers",
    "iDisplayLength": 25,
    "aLengthMenu": [ 25, 50, -1 ]
  });
});
</script>

<link href="{% static 'css/introjs.css' %}" rel="stylesheet">
<script type="text/javascript" src="{% static 'js/intro.js' %}"></script>
{% if do_intro %}<script type="text/javascript">introJs().start()</script>{% endif %}

<link href="{% static 'css/donuts.css' %}" rel="stylesheet">
<script src="{% static 'js/donuts.js' %}"></script>

<script type="text/javascript">$('span.badge').tooltip();</script>
<script type="text/javascript">$('button.btn').tooltip();</script>
<script type="text/javascript">$('select.file_name').tooltip();</script>
{% endblock %}
